# 更新日志

## [1.2.2] - 2025-01-27

### 重大改进 🚀

- **图片批注识别**: 自动识别针对图片的批注，批注原文显示"【图片】"
  - 检测XML中的图片元素：`<w:drawing>`、`<w:pict>`、`<pic:pic>`
  - 智能判断无文本但有内容的批注为图片批注

- **智能章节序号推断**: 结合文档结构自动推断准确的章节序号
  - 新增`getHeadingLevel`函数，识别标题级别（Heading 1-6）
  - 新增`inferSectionNumbers`函数，智能推断章节序号
  - 支持多级标题的自动编号（如1.1、1.2.1、2.3.4等）
  - 自动识别已有序号的标题，避免重复编号

- **章节定位重构**: 完全重构章节识别算法，大幅提高准确性
  - 基于XML位置的精确章节定位，而非简单的顺序遍历
  - 新增`extractSectionPositions`函数，构建章节位置映射
  - 新增`findNearestSection`函数，根据批注位置查找最近章节
  - 解决批注章节显示不准确的问题

### 技术架构优化 🔧

- **解析逻辑重构**: 采用基于位置的解析策略
  - 直接从XML字符串提取批注范围和位置信息
  - 构建章节位置索引，实现O(n)时间复杂度的章节查找
  - 移除复杂的段落遍历逻辑，简化代码结构

- **代码清理**: 删除未使用的函数和接口
  - 移除`findCommentRanges`、`findCommentRangesImproved`等冗余函数
  - 清理未使用的TypeScript接口定义
  - 优化代码结构，提高可维护性

### 修复问题 🐛

- **批注原文准确性**: 修复图片批注显示"无原文"的问题
- **章节定位准确性**: 修复批注章节显示错误的问题
- **性能优化**: 减少不必要的XML解析，提高处理速度

### 调试增强 🔍

- 增加章节位置信息的详细日志
- 显示每个批注的位置和对应章节
- 提供更精确的解析统计信息

## [1.2.1] - 2025-01-27

### 新增功能 ✨

- **批注ID列**: 新增"批注ID"列，显示批注的唯一标识符（w:id），方便调试和排查问题
- **标题号支持**: 章节标题现在支持多种标题号格式
  - 数字格式：1.1、1.1.1、2.3.4等
  - 中文数字：一、二、三等
  - 罗马数字：I、II、III等
  - 字母格式：A、B、C等

### 技术改进 🔧

- **重构批注原文解析**: 使用直接XML字符串解析，提高批注原文提取准确性
  - 新增`extractCommentRangesFromXml`函数，直接从XML字符串提取批注范围
  - 新增`extractTextFromXmlRange`函数，从XML范围提取文本内容
  - 新增`extractTitleWithNumber`函数，智能提取带标题号的章节标题
  - 新增`findCommentRangesImproved`函数，结合多种方法提高解析成功率

### 调试优化 🐛

- 添加详细的控制台日志，便于问题排查
- 显示解析进度和结果统计
- 记录每个批注的原文和章节信息

### 界面优化 🎨

- 批注ID列使用等宽字体显示，便于识别
- 调整Excel导出列宽，适应新的批注ID列

### 修复问题 🔧

- 修复大量批注显示"未知章节"和"无原文"的问题
- 改进XML解析逻辑，更准确地定位批注范围和章节信息
- 优化标题识别算法，支持更多标题格式

## [1.2.0] - 2025-01-27

### 新增功能 ✨

- **批注原文和所属章节支持**: 新增对Word文档批注原文和所属章节的解析功能
  - 解析`word/document.xml`文件，提取批注对应的原始文本
  - 解析`word/styles.xml`文件，识别标题样式
  - 通过批注位置向上查找最近的标题段落作为所属章节
  - 在表格中新增"所属章节"和"批注原文"列
  - Excel导出包含完整的章节和原文信息

### 技术改进 🔧

- 扩展`Comment`接口，添加`originalText`和`section`字段
- 新增`parseStyles`函数，解析Word文档样式定义
- 新增`parseDocument`函数，解析文档结构和批注范围
- 改进批注范围查找算法，支持跨多个run元素的批注
- 优化XML解析性能，支持大型文档处理

### 数据结构变更 📊

```typescript
// 更新的Comment接口
interface Comment {
  id: string
  author: string
  date: string
  text: string
  paraId?: string
  replies?: Comment[]
  originalText?: string  // 新增：批注原文
  section?: string       // 新增：所属章节
}
```

### 解析逻辑 🔍

- 解析`word/styles.xml`识别标题样式（heading 1, heading 2等）
- 解析`word/document.xml`遍历文档结构
- 通过`commentRangeStart`和`commentRangeEnd`标签提取批注原文
- 向上查找最近的标题段落确定批注所属章节
- 支持复杂的批注范围和嵌套结构

### 界面优化 🎨

- 新增"所属章节"列，显示批注所属的文档章节
- 新增"批注原文"列，显示被批注的原始文本内容
- 优化列宽设置，提升表格显示效果
- 无数据时显示友好的提示信息

### 导出功能 📤

- Excel文件新增"所属章节"和"批注原文"列
- 调整列宽设置，优化导出文件格式
- 无数据时显示"未知章节"和"无原文"

## [1.1.0] - 2025-05-25

### 新增功能 ✨

- **批注答复支持**: 新增对Word文档批注答复功能的完整支持
  - 自动解析`word/commentsExtended.xml`文件
  - 识别批注间的父子关联关系（基于`w15:paraIdParent`属性）
  - 在表格中新增"答复批注"列，层级显示主批注和答复
  - Excel导出包含完整的答复批注信息

### 技术改进 🔧

- 扩展`Comment`接口，添加`paraId`和`replies`字段
- 优化`parseDocxComments`函数，支持解析批注扩展信息
- 改进表格列定义，美化答复批注的显示效果
- 更新Excel导出逻辑，格式化答复批注数据

### 数据结构变更 📊

```typescript
// 新的Comment接口
interface Comment {
  id: string
  author: string
  date: string
  text: string
  paraId?: string      // 新增：段落ID
  replies?: Comment[]  // 新增：答复批注数组
}
```

### 解析逻辑 🔍

- 解析`word/comments.xml`获取基础批注信息
- 解析`word/commentsExtended.xml`建立父子关系
- 通过`paraId`映射关联主批注和答复批注
- 过滤返回顶级批注（非答复的批注）

### 界面优化 🎨

- 答复批注采用缩进样式显示
- 使用蓝色左边框区分答复内容
- 显示答复者信息和时间
- 无答复时显示"无答复"提示

### 导出功能 📤

- Excel文件新增"答复批注"列
- 答复内容格式：`作者 (日期): 内容`
- 多个答复用双换行符分隔
- 无答复显示"无答复"

## [1.0.0] - 2025-05-24

### 初始功能 🎉

- DOCX文件上传和解析
- 批注内容提取和展示
- 表格排序和筛选
- Excel导出功能
- 响应式界面设计
- 明暗主题支持
